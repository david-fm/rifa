---
import Layout from "../layouts/Layout.astro";
import Input from "../components/Input";
import Button from "../components/Button";

interface User {
    username: string;
    gmail: string;
    
}
interface Creador {
    basic : User;
    logo: string;
    support_link: string;
    support_type: number;
}

const { cookies, redirect } = Astro;

const accessToken = cookies.get("sb-access-token");
const refreshToken = cookies.get("sb-refresh-token");

const creador: Creador = {
    basic: {
        username: "Creador",
        gmail: "mi@gmail.com",
    },
    logo: "https://avatars.githubusercontent.com/u/472319",
    support_link: "https://www.google.com",
    support_type: 0,
};

const user: User = {
    username: "Creador",
    gmail: "mi@gmail.com",
};

if (!(accessToken && refreshToken)) {
    redirect("/login");
}


// TODO: comprobar tipo de usuario, si es creador o no

const iscreador = cookies.get("iscreador") !== undefined ? true : false;
---

<Layout title="KingRifa">
    <div class="flex flex-col items-center justify-center h-full">
        <div class="flex flex-col items-center justify-center w-96" id={iscreador?"creador":"baseUser"}>
            {
                iscreador && (
                <img src={creador.logo} class="w-24 h-24 rounded-full cursor-pointer" id="img"/>
                )

            }
            <h1 class="text-2xl font-bold mt-4" id="username">{creador.basic.username}</h1>
            <p class="text-sm text-gray-500 mt-1" id="gmail">Gmail: {creador.basic.gmail}</p>
            {
                iscreador && (
                    <p class="text-sm text-gray-500 mt-1" id="supportLink">Link soporte: {creador.support_link}</p>
                )
            }
            
            <form class="pt-4 flex flex-col items-center" action="/api/auth/edit">
                {
                    iscreador && (
                        <Input type="file" placeholder="Logo" extraClass="hidden" id="logoInput" name="image"/>
                    )
                }
                
                <Input name="username" type="text" placeholder="Nombre de usuario" id="usernameInput" isRequiered/>
                {
                    iscreador && (
                        <Input name="support_link" type="text" placeholder="Link soporte" id="supportLinkInput" isRequiered/>
                    )
                }
                {/* 
                <Input type="text" placeholder="Correo electrónico" />
                
                <Input type="password" placeholder="Contraseña" />
                <Input type="password" placeholder="Contraseña actual" />*/}
                <Button type="submit" text="Actualizar"/>
            </form>
        </div>
    </div>
</Layout>

<script>
    import { isLocalStorageAvailable } from "../lib/functions";
    import type { userDetails } from "../types/localStorage";
    
    const creador = document.getElementById("creador");
    const baseUser = document.getElementById("baseUser");
    const form = document.querySelector("form");

    const username =  document.getElementById("username");
    const gmail = document.getElementById("gmail");
    const supportLink = document.getElementById("supportLink");
    const img = document.getElementById("img") as HTMLImageElement;

    const logoInput = document.getElementById("logoInput") as HTMLInputElement;
    const usernameInput = document.getElementById("usernameInput") as HTMLInputElement;
    const supportLinkInput = document.getElementById("supportLinkInput") as HTMLInputElement;
    
    const isCreador = creador !== null;
    
    function updateContent(user: userDetails){
        if (isCreador){
            

            if(username && gmail && supportLink && img && logoInput && usernameInput && supportLinkInput){
                username.textContent = user.username?user.username:"My username";
                gmail.textContent = user.email;
                supportLink.textContent = user.creadorInfo?.support_link?user.creadorInfo?.support_link:"";
                //console.log(supportLink.textContent);

                usernameInput.value = user.username?user.username:"";
                //console.log(usernameInput.value);
                supportLinkInput.value = user.creadorInfo?.support_link ? user.creadorInfo?.support_link:"";
                //console.log(user.creadorInfo);
                //console.log(supportLinkInput.value);
                //logoInput.src = user.creadorInfo?.logo?user.creadorInfo?.logo:"";
                //img.src = user.logo;
            }
            else{
                console.error("No se ha podido encontrar alguno de los elementos");
            }
        }
        else{

            if(username && gmail && usernameInput){
                username.textContent = user.username?user.username:"My username";
                gmail.textContent = user.email;

                usernameInput.value = user.username?user.username:"";
            }
            else{
                console.error("No se ha podido encontrar alguno de los elementos");
            }

        }
    }

    async function getUserData(){
        let user: userDetails | null;
        user = null;
        if (isLocalStorageAvailable() && false) {
            user = JSON.parse(localStorage.getItem("userDetails") as string);
        }
        if(user === null){
            const userData = await fetch("/api/auth/userdata",{
                method: "POST"
            });
            user = await userData.json();
        }

        return user;
    }
    function updateUser(data:any, actualUser: userDetails){
        if (isCreador){

            if(username && supportLink && img && logoInput && usernameInput && supportLinkInput){
                username.textContent = data.username;
                supportLink.textContent = data.support_link;
                //img.src = data.logo;

                usernameInput.value = data.username;
                supportLinkInput.value = data.support_link;
                //logoInput.src = data.logo;
            }
        }
        else{
            if(username && usernameInput){
                username.textContent = data.username;
                usernameInput.value = data.username;
            }
        }
        if (isLocalStorageAvailable()) {
            actualUser.username = data.username;
            if (isCreador){
                if(!actualUser.creadorInfo) 
                    actualUser.creadorInfo = {
                        logo: "",
                        support_link: data.support_link,
                        support_type: 0
                    };
                else
                    actualUser.creadorInfo.support_link = data.support_link;
                //actualUser.logo = data.logo;
            }

            localStorage.setItem("userDetails", JSON.stringify(actualUser));
        }
    }
    let actualUser: userDetails;

    getUserData().then((user) => {
        if(user)
        {
            actualUser = user;
            updateContent(user);
        }
    });

    img?.addEventListener("click", () => {
        const input = document.querySelector("input[type='file']") as HTMLInputElement;
        input?.click();
    });
    logoInput?.addEventListener('change', event => {
        if (logoInput.files === null) return;
        const [file] = logoInput.files;
        const reader = new FileReader();

        reader.addEventListener('load', event => {
            if(img.src && event.target?.result !== null)
            {
                let value: string | ArrayBuffer | undefined = event.target?.result;

                if (typeof value === 'string' ) {
                    let stringValue: string = value;
                    // Ahora puedes usar stringValue
                    img.src = stringValue;
                } else {
                    // Manejar el caso en que value no es un string
                }
            }
                
        });

        reader.addEventListener('error', event => {
            console.log('error', event);
        });

        reader.readAsDataURL(file);
        });
    form?.addEventListener("submit", (e) => {
        e.preventDefault();
        const formData = new FormData(form as HTMLFormElement);
        fetch("/api/auth/edit", {
            method: "POST",
            body: formData,
        }).then((res) => {
            if (res.ok) {
                res.json().then((data) => {
                    updateUser(data, actualUser);
                });
            }
        })
    });
</script>